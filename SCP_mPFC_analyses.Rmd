---
title: "SCP mPFC RSA Modelling"
output: html_notebook
---

Sam Audrain November 2020 
V 0.0.1

# Read in required packages
```{r}
library(nlme)
library(lme4)
library(ggplot2)
library(emmeans)
library(Rmisc)
library(psych)

```


# Create dataset for stats comparisons based on delay and congruency. 
- Correlations are fisher transformed into normal distributions for statistical comparison here 
- within context correlations are the main correlations of interest
- computed cross context correlations for subsequent control analysis 

```{r}

# short = short delay data, long = long delay data
delays<-c("short", "long")

# R = congruent, UR = incongruent
conds<-c("R", "UR")

# ROIs
masks<-c("BNA_mPFC2")

# within context vs across context correlations 
grans<-c("wincon", "xcon")

for (delay in delays){
  for (cond in conds){
    for (gran in grans){
      for (mask in masks){
         data<-read.csv(paste("~/Dropbox/Sam/Schema_Consolidation_Project/R_SCP/SCP_StatsModels_clean/RSA_output/",cond,"_corrs_",gran,"_",delay,"_",mask,".csv",sep=""),header = FALSE, sep=" ",stringsAsFactors = FALSE)
        colnames(data)<- c("subj", "trial", "mask", "R")
        data$R_fish<-fisherz(data$R)
        data$condition<-rep(gran, (nrow(data)))
        data$delay<-rep(delay, (nrow(data)))
        data$congruency<-rep(cond, (nrow(data)))
        # make naming convention the same across delays for counterbalanced subjects 
        for (r in 1:nrow(data)){
          if (data[r,"subj"] == "P201_20181101"){
            data[r,"subj"]<-"P101_20181029"
          } else if (data[r,"subj"] == "S205_20181116"){
            data[r,"subj"]<-"S105_20181113"
          } else if (data[r,"subj"] == "S206_20181122"){
            data[r,"subj"]<-"S106_20181119"
          } else if (data[r,"subj"] == "S207_20181129"){
            data[r,"subj"]<-"S107_20181126"
          } else if (data[r,"subj"] == "S209_20190117"){
            data[r,"subj"]<-"S109_20190114"
          } else if (data[r,"subj"] == "S210_20190123"){
            data[r,"subj"]<-"S110_20190120"
          }
        }
        name<-paste(delay,mask,cond,gran,sep="_")
        assign(name,data) #saves the mean and std under the current masks name
      }
    }
  }
}

# within context correlation dataset
mPFC_data_wincon<-rbind(short_BNA_mPFC2_R_wincon,short_BNA_mPFC2_UR_wincon,long_BNA_mPFC2_R_wincon,long_BNA_mPFC2_UR_wincon)

# within and across context correlation dataset 
mPFC_data<-rbind(short_BNA_mPFC2_R_wincon,short_BNA_mPFC2_R_xcon,short_BNA_mPFC2_UR_wincon,short_BNA_mPFC2_UR_xcon,long_BNA_mPFC2_R_wincon,long_BNA_mPFC2_R_xcon, long_BNA_mPFC2_UR_wincon,long_BNA_mPFC2_UR_xcon)

# cleanup enviro 
rm(short_BNA_mPFC2_R_wincon,short_BNA_mPFC2_R_xcon,short_BNA_mPFC2_UR_wincon,short_BNA_mPFC2_UR_xcon,long_BNA_mPFC2_R_wincon,long_BNA_mPFC2_R_xcon, long_BNA_mPFC2_UR_wincon,long_BNA_mPFC2_UR_xcon)

```

# Model and plot the within context correlations in mPFC
```{r, fig.height=5,fig.width=4.5}

# model 
model<-lme(R_fish ~ delay*congruency, random= ~1|subj, data=mPFC_data_wincon, na.action=na.omit) 
anova(model)

#pairwise comparisons
emmeans(model,list(pairwise ~ delay:congruency), adjust = "none") 

## Plot
## use estimated marginal means 
eff_interaction <-emmeans(model, specs = c("delay","congruency")) #se is not for within subject data here
eff_interaction_df <- as.data.frame(eff_interaction)
## use within subject se 
stats<-summarySEwithin(data=mPFC_data_wincon, measurevar = "R_fish", withinvars = c("congruency","delay"), idvar = "subj", na.rm=TRUE)
## add estiamted marginal mean to the stats dataset 
stats$emmean<-eff_interaction_df$emmean
stats$upper_se<-stats$emmean + stats$se
stats$lower_se<-stats$emmean - stats$se
stats

ggplot(stats, aes(x=delay, y=emmean, fill=congruency)) + 
  theme_classic() +
  geom_bar(stat = "identity", position = "dodge", width = 0.8, color="black") + 
  geom_errorbar(width = .0, position = position_dodge(0.8), aes(ymin=lower_se, ymax=upper_se))+
  labs(x="", y="similarity (Fisher z)") +
  theme(axis.title = element_text(size=20), axis.ticks.x=element_blank()) +
  theme(axis.text=element_text(size=18))+
  labs(fill="") +
  scale_fill_manual(values=c("#85929E","#D5D8DC"), labels = c("congruent", "incongruent"))+
  scale_x_discrete(limits=c("short", "long"), labels=c("short", "long"))+
  scale_y_continuous(breaks = seq(0,0.08,0.01), expand = c(0, 0), limits = c(0,0.08))+
  geom_hline(yintercept=0)+
  ggtitle("mPFC")+
  theme(plot.title = element_text(size=22, face="bold", hjust=0.5), legend.text=element_text(size=16), legend.position = "bottom")

 
```


# Control Analysis: Is is integration within context greater than across contexts in each condition?

## Congruent
```{r, fig.height=5,fig.width=5}
# model
model<-lme(R_fish ~ condition*delay, random= ~1|subj, data=mPFC_data, na.action=na.omit, subset=congruency=="R")
anova(model)

#investigating main effects 
emmeans(model,list(pairwise ~ condition), adjust = "none") 
emmeans(model,list(pairwise ~ delay), adjust = "none") 

## plot 
eff_interaction<-as.data.frame(emmeans(model, list(pairwise ~ condition:delay), adjust = "none"))
eff_interaction<-subset(eff_interaction, contrast == ".")
stats<-summarySEwithin(data=mPFC_data, measurevar = "R_fish", withinvars = c("delay","condition"), idvar = "subj", na.rm=TRUE)
## add estiamted marginal mean to the stats dataset 
stats$emmean<-eff_interaction$emmean
stats$upper_se<-stats$emmean + stats$se
stats$lower_se<-stats$emmean - stats$se
stats

ggplot(stats, aes(x=delay, y=emmean, fill=condition)) + 
  theme_classic() +
  geom_bar(stat = "identity", position = "dodge", width = 0.8, color="black") + 
  geom_errorbar(width = .0, position = position_dodge(0.8), aes(ymin=lower_se, ymax=upper_se))+
  labs(x="", y="similarity (Fisher z)") +
  theme(axis.title = element_text(size=18), axis.ticks.x=element_blank(), legend.position="bottom") +
  theme(axis.text=element_text(size=16))+
  labs(fill="") +
  scale_fill_manual(values=c("#74ADD1","#E0F3F8"), labels = c("within", "across"))+
  scale_x_discrete(limits=c("short", "long"), labels=c("short", "long"))+
  scale_y_continuous(breaks = seq(0,0.08,0.01),expand = c(0, 0), limits = c(0,0.08))+
  geom_hline(yintercept=0)+
  ggtitle("congruent")+
  theme(plot.title = element_text(size=20, face="bold", hjust=0.5), legend.text=element_text(size=16))

```

## Incongruent
```{r, fig.height=5,fig.width=5}

# model 
model<-lme(R_fish ~ condition*delay, random= ~1|subj, data=mPFC_data, na.action=na.omit, subset=congruency=="UR")
anova(model)

# investigating main effects
emmeans(model, list(pairwise ~ delay), adjust = "none")

## plot 
eff_interaction<-as.data.frame(emmeans(model, list(pairwise ~ condition:delay), adjust = "none"))
eff_interaction<-subset(eff_interaction, contrast == ".")
stats<-summarySEwithin(data=mPFC_data, measurevar = "R_fish", withinvars = c("delay","condition"), idvar = "subj", na.rm=TRUE)
## add estiamted marginal mean to the stats dataset 
stats$emmean<-eff_interaction$emmean
stats$upper_se<-stats$emmean + stats$se
stats$lower_se<-stats$emmean - stats$se
stats

ggplot(stats, aes(x=delay, y=emmean, fill=condition)) + 
  theme_classic() +
  geom_bar(stat = "identity", position = "dodge", width = 0.8, color="black") + 
  geom_errorbar(width = .0, position = position_dodge(0.8), aes(ymin=lower_se, ymax=upper_se))+
  labs(x="", y="similarity (Fisher z)") +
  theme(axis.title = element_text(size=18), axis.ticks.x=element_blank(), legend.position="bottom") +
  theme(axis.text=element_text(size=16))+
  labs(fill="") +
  scale_fill_manual(values=c("#74ADD1","#E0F3F8"), labels = c("within", "across"))+
  scale_x_discrete(limits=c("short", "long"), labels=c("short", "long"))+
  scale_y_continuous(breaks = seq(0,0.08,0.01),expand = c(0, 0), limits = c(0,0.08))+
  geom_hline(yintercept=0)+
  ggtitle("incongruent")+
  theme(plot.title = element_text(size=20, face="bold", hjust=0.5), legend.text=element_text(size=16))

```


